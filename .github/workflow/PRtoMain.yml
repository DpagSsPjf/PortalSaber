name: PR to Main

on:
  pull_request:
    branches:
      - main

jobs:
  test-and-create-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Last merge
        run: |
          LAST_MERGE=$(git log --merges --pretty=format:"%H" origin/main..origin/dev | head -n 1)
          echo "LAST_MERGE=$LAST_MERGE" >> $GITHUB_ENV
      
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npm run type-check || npm run tsc || echo "Executando verifica√ß√£o de tipos TypeScript"

      - name: Build Next.js application
        run: npm run build

      - name: Get last commit message
        id: get-commit-message
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" ${{ env.LAST_MERGE }})
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Promo√ß√£o Dev para Main"
          title: "üöÄ Promo√ß√£o Dev para Main ${{ steps.jira_tickets.outputs.tickets }}"
          body: |
            ## Solicita√ß√£o de Promo√ß√£o para Produ√ß√£o

            Este PR foi gerado automaticamente para promover as altera√ß√µes da branch Dev para Main.

            ### üîÑ Altera√ß√µes Inclu√≠das
            ${{ steps.get_changes.outputs.changes }}

            ### ‚úÖ Verifica√ß√µes
            - [x] Build Next.js executado com sucesso
            - [x] Verifica√ß√£o de tipos TypeScript
            - [x] Testes unit√°rios executados
            - [ ] Revis√£o de c√≥digo necess√°ria
            - [ ] Testes em ambiente de homologa√ß√£o realizados

            ### üìã Notas Adicionais
            - Certifique-se de revisar todas as altera√ß√µes antes de mesclar.
            - Ap√≥s a mesclagem, monitore o ambiente de produ√ß√£o para quaisquer problemas.
          base: main
          branch: promote-dev-to-main
          labels: |
            promotion
            automated
            needs-review
            next-js
